<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥æ™‚è¨˜éŒ„å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* è‡ªè¨‚æ¨£å¼ */
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #FFF0F5; /* æ·¡ç²‰ç´…è‰²èƒŒæ™¯ */
        }
        /* ä¸»è¦å®¹å™¨æ¨£å¼ */
        .main-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #FFFFFF; /* ç™½è‰²èƒŒæ™¯ */
            border-radius: 1.5rem; /* å¤§åœ“è§’ */
            box-shadow: 0 10px 25px -5px rgba(219, 39, 119, 0.1), 0 8px 10px -6px rgba(219, 39, 119, 0.1); /* ç²‰è‰²æŸ”å’Œé™°å½± */
            position: relative; /* ç‚ºäº†è²“å’ªå®šä½ */
            overflow: hidden; /* é¿å…è²“å’ªè¶…å‡ºç¯„åœ */
        }
        /* æŒ‰éˆ•åŸºæœ¬æ¨£å¼ */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem; /* åœ“è§’ */
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            display: inline-flex; /* Align icon and text */
            align-items: center;
            justify-content: center;
        }
        /* æŒ‰éˆ•ç¦ç”¨æ¨£å¼ */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* ä¸»è¦æŒ‰éˆ•æ¨£å¼ (ç²‰è‰²) */
        .btn-primary {
            background-color: #EC4899; /* ç²‰ç´…è‰² */
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #DB2777; /* æ·±ä¸€é»çš„ç²‰ç´…è‰² */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(219, 39, 119, 0.2), 0 4px 6px -4px rgba(219, 39, 119, 0.2);
        }
        /* æ¬¡è¦æŒ‰éˆ•æ¨£å¼ (å¥¶æ²¹è‰²) */
        .btn-secondary {
            background-color: #FFFBEB; /* å¥¶æ²¹è‰² */
            color: #D97706; /* æ­é…çš„æ–‡å­—é¡è‰² */
            border: 1px solid #FDE68A;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #FEF3C7;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.1), 0 4px 6px -4px rgba(245, 158, 11, 0.1);
        }
         /* æ¸…é™¤æŒ‰éˆ•æ¨£å¼ (æ·¡ç´…è‰²) */
        .btn-danger {
            background-color: #FEF2F2; /* Very light red */
            color: #DC2626; /* Red text */
            border: 1px solid #FECACA; /* Light red border */
            padding: 0.3rem 0.6rem; /* Smaller padding */
            font-size: 0.875rem; /* Smaller text */
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #FEE2E2; /* Slightly darker light red */
            color: #B91C1C; /* Darker red text */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.1), 0 2px 4px -2px rgba(220, 38, 38, 0.06);
        }
        /* æ–°å¢æŒ‰éˆ•æ¨£å¼ (æ·ºè—è‰²) */
        .btn-light-blue {
            background-color: #F0F9FF; /* Very light blue */
            color: #0369A1; /* Blue text */
            border: 1px solid #BAE6FD; /* Light blue border */
            padding: 0.3rem 0.6rem; /* Match danger button padding */
            font-size: 0.875rem; /* Match danger button font size */
        }
        .btn-light-blue:hover:not(:disabled) {
            background-color: #E0F2FE; /* Slightly darker light blue */
            color: #0284C7; /* Darker blue text */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.1), 0 2px 4px -2px rgba(14, 165, 233, 0.06);
        }
        /* åœ–ç¤ºæŒ‰éˆ•æ¨£å¼ */
        .icon-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            color: #9CA3AF; /* ç°è‰² */
            transition: color 0.3s ease;
        }
        .icon-btn:hover {
            color: #EC4899; /* ç²‰ç´…è‰² */
        }
        /* å€å¡Šæ¨™é¡Œæ¨£å¼ */
        .section-title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #F9A8D4; /* æ·ºç²‰ç´…åº•ç·š */
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #DB2777; /* æ·±ç²‰ç´…è‰² */
            margin: 0; /* Remove default margin */
            padding: 0; /* Remove default padding */
            border: none; /* Remove individual border */
            display: inline-block;
        }
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        input[type="text"], textarea {
            border: 1px solid #FBCFE8; /* ç²‰è‰²é‚Šæ¡† */
            border-radius: 0.75rem; /* åœ“è§’ */
            padding: 0.5rem 0.75rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #EC4899; /* ç²‰è‰² */
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2); /* ç²‰è‰²å¤–å…‰æšˆ */
        }
        input[readonly], input.bg-gray-100[readonly] { /* Style readonly fields */
             background-color: #f3f4f6; /* Lighter gray */
             cursor: default;
             opacity: 0.7;
        }
        /* å¾…è¾¦äº‹é …å®Œæˆæ¨£å¼ */
        .todo-item.completed span {
            text-decoration: line-through;
            color: #9CA3AF; /* ç°è‰² */
        }
        /* è²“å’ª SVG æ¨£å¼ */
        .cat-illustration {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            width: 100px; /* èª¿æ•´è²“å’ªå¤§å° */
            height: auto;
            opacity: 0.8; /* ç¨å¾®é€æ˜ä¸€é» */
            pointer-events: none; /* é¿å…æ“‹ä½æ“ä½œ */
        }
        /* ç¢¼éŒ¶æ¨£å¼ */
        #timerDisplay {
            font-size: 3.5rem; /* æ”¾å¤§ç¢¼éŒ¶å­—é«” */
            font-weight: bold;
            color: #374151; /* æ·±ç°è‰² */
            background-color: #FFFBEB; /* å¥¶æ²¹è‰²èƒŒæ™¯ */
            padding: 1rem 2rem;
            border-radius: 1rem; /* åœ“è§’ */
            display: inline-block; /* ä½¿èƒŒæ™¯ç¬¦åˆå…§å®¹å¯¬åº¦ */
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* å…§é™°å½±å¢åŠ ç«‹é«”æ„Ÿ */
            letter-spacing: 2px; /* å¢åŠ å­—é–“è· */
            min-width: 280px; /* ç¢ºä¿å¯¬åº¦ */
            text-align: center;
        }
        /* ç´€éŒ„å¡ç‰‡æ¨£å¼ */
        .record-card {
            background-color: #FFFBEB; /* å¥¶æ²¹è‰² */
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #F9A8D4; /* å·¦å´ç²‰è‰²é‚Šæ¡† */
        }
        /* Modal æ¨£å¼ */
        .modal {
            display: none; /* é è¨­éš±è— */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* å‚ç›´ç½®ä¸­ */
            padding: 25px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
        }
        /* è®€å–ä¸­/å„²å­˜ä¸­æç¤º */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 60; /* ç¢ºä¿åœ¨ modal ä¹‹ä¸Š */
            font-weight: bold;
            color: #EC4899;
            border-radius: 1rem; /* Match modal content */
        }
        /* Spinner for loading state */
        .spinner {
          border: 4px solid rgba(0, 0, 0, 0.1);
          width: 36px;
          height: 36px;
          border-radius: 50%;
          border-left-color: #EC4899;
          margin-right: 10px;
          animation: spin 1s ease infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        /* Placeholder text style */
        .placeholder-text {
            color: #a1a1aa; /* Zinc 400 */
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }
    </style>
</head>
<body class="text-gray-700">

    <div class="main-container">

        <h1 class="text-3xl font-bold text-center mb-8 text-pink-600">å·¥æ™‚è¨˜éŒ„å™¨</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

            <div class="space-y-6">
                <section class="text-center p-6 bg-white rounded-xl shadow-md border border-pink-100">
                    <h2 class="section-title mb-4">â±ï¸ è¨ˆæ™‚å€</h2>
                    <div id="timerDisplay">00:00:00</div>
                    <div class="mt-6 space-x-4">
                        <button id="startPauseBtn" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                            é–‹å§‹
                        </button>
                        <button id="endBtn" class="btn btn-secondary" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 10a2 2 0 104 0 2 2 0 00-4 0z" clip-rule="evenodd" />
                            </svg>
                            çµæŸ
                        </button>
                    </div>
                </section>

                <section class="p-6 bg-white rounded-xl shadow-md border border-pink-100">
                    <div class="section-title-container">
                        <h2 class="section-title">ğŸ“‘ å·¥ä½œç´€éŒ„æ¸…å–®</h2>
                        <div class="space-x-2">
                            <button id="addNewRecordBtn" class="btn btn-light-blue" title="æ–°å¢å·¥ä½œç´€éŒ„">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                æ–°å¢
                            </button>
                            <button id="clearAllRecordsBtn" class="btn btn-danger" title="æ¸…é™¤æ‰€æœ‰å·¥ä½œç´€éŒ„">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                æ¸…é™¤
                            </button>
                        </div>
                    </div>
                    <div id="recordList" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                        <p class="placeholder-text">é‚„æ²’æœ‰å·¥ä½œç´€éŒ„å–”ï¼é–‹å§‹è¨˜éŒ„å§ï½</p>
                    </div>
                     <button id="exportBtn" class="btn btn-primary mt-6 w-full" title="åŒ¯å‡ºæ‰€æœ‰ç´€éŒ„ç‚º CSV æª”æ¡ˆ">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
                          <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
                        </svg>
                        åŒ¯å‡ºæ‰€æœ‰ç´€éŒ„
                    </button>
                </section>
            </div>

            <div class="space-y-6">
                <section class="p-6 bg-white rounded-xl shadow-md border border-pink-100 h-full flex flex-col">
                     <div class="section-title-container">
                        <h2 class="section-title">ğŸ“ å¾…è¾¦æ¸…å–®</h2>
                         <button id="clearAllTodosBtn" class="btn btn-danger" title="æ¸…é™¤æ‰€æœ‰å¾…è¾¦äº‹é …">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            æ¸…é™¤
                        </button>
                    </div>
                    <div class="flex mb-4">
                        <input type="text" id="newTodoInput" placeholder="æ–°å¢å¾…è¾¦äº‹é …..." class="flex-grow mr-2">
                        <button id="addTodoBtn" class="btn btn-primary px-3"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div id="todoList" class="space-y-2 overflow-y-auto flex-grow pr-2">
                         <p class="placeholder-text">é‚„æ²’æœ‰å¾…è¾¦äº‹é …å–”ï¼æ–°å¢ä¸€äº›å§ï½</p>
                    </div>
                </section>
            </div>
        </div>

        <svg class="cat-illustration" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <path fill="#FBCFE8" d="M48.1,-61.3C62.2,-53.1,73.4,-39.8,79.5,-24.8C85.6,-9.8,86.6,6.9,80.8,21.2C75,35.5,62.4,47.4,49.1,56.9C35.8,66.4,21.8,73.4,6.9,74.7C-8,76,-23.8,71.5,-38.8,64.1C-53.8,56.7,-67.9,46.4,-75.5,32.9C-83.1,19.4,-84.1,2.7,-79.9,-12.5C-75.7,-27.7,-66.3,-41.4,-54.1,-49.6C-41.9,-57.8,-26.9,-60.5,-13.4,-63.5C0,-66.5,14,-69.6,28.1,-70.5C42.2,-71.4,56.3,-70.1,60.4,-61.3" transform="translate(100 100) scale(0.9)"> </path>
           <circle cx="90" cy="90" r="5" fill="#374151"/>
          <circle cx="110" cy="90" r="5" fill="#374151"/>
          <path d="M 95 105 Q 100 115 105 105" stroke="#374151" stroke-width="2" fill="none"/>
        </svg>

    </div>

    <div id="recordModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="closeModalBtn">&times;</span>
        <h3 class="text-xl font-bold mb-4 text-pink-600">è¨˜éŒ„å·¥ä½œ</h3>
        <div class="space-y-3">
            <input type="hidden" id="recordId">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ™‚é–“</label>
                <input type="datetime-local" id="startTime" class="w-full rounded-lg border-pink-200 focus:border-pink-500 focus:ring focus:ring-pink-200">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ™‚é–“</label>
                <input type="datetime-local" id="endTime" class="w-full rounded-lg border-pink-200 focus:border-pink-500 focus:ring focus:ring-pink-200">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">å·¥ä½œæ™‚æ•¸ (å°æ™‚)</label>
                <input type="text" id="duration" class="bg-gray-100" readonly>
            </div>
            <div>
                <label for="workContent" class="block text-sm font-medium text-gray-700 mb-1">å·¥ä½œå…§å®¹</label>
                <input type="text" id="workContent" placeholder="è«‹è¼¸å…¥å·¥ä½œå…§å®¹...">
            </div>
            <div>
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»</label>
                <textarea id="notes" rows="3" placeholder="é¸å¡«"></textarea>
            </div>
            <div class="text-right pt-3">
                <button id="saveRecordBtn" class="btn btn-primary">å„²å­˜ç´€éŒ„</button>
            </div>
        </div>
         <div id="modalLoading" class="loading-overlay" style="display: none;">
            <div class="spinner"></div> å„²å­˜ä¸­...
        </div>
      </div>
    </div>


    <script>
        // --- DOM Elements ---
        const timerDisplay = document.getElementById('timerDisplay');
        const startPauseBtn = document.getElementById('startPauseBtn');
        const endBtn = document.getElementById('endBtn');
        const recordList = document.getElementById('recordList');
        const exportBtn = document.getElementById('exportBtn');
        const clearAllRecordsBtn = document.getElementById('clearAllRecordsBtn');
        const newTodoInput = document.getElementById('newTodoInput');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const todoList = document.getElementById('todoList');
        const clearAllTodosBtn = document.getElementById('clearAllTodosBtn');


        // Modal elements
        const recordModal = document.getElementById('recordModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const recordIdInput = document.getElementById('recordId');
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');
        const durationInput = document.getElementById('duration');
        const workContentInput = document.getElementById('workContent');
        const notesInput = document.getElementById('notes');
        const modalLoading = document.getElementById('modalLoading');


        // --- Timer State ---
        let timerInterval = null;
        let startTime = null; // Date object when timer started
        let pausedTime = 0; // Total time paused in milliseconds
        let pauseStart = null; // Timestamp when pause started
        let isRunning = false;
        let currentSegments = []; // æ–°å¢ï¼šè¨˜éŒ„æ¯ä¸€æ®µæœ‰æ•ˆå·¥æ™‚

        // --- Data Storage ---
        let workRecords = []; // Initialized in initializeApp
        let todos = [];       // Initialized in initializeApp

        // --- Google Sheets Integration ---
        const SPREADSHEET_ID = '1hGiFEh-WLTE05YReUgBghXRRlb8lO7z1HUJkDs5SFNU';
        const SHEET_NAME = 'å·¥æ™‚ç´€éŒ„';
        const CLIENT_ID = '546512436191-n58cui9bj25js8m5p01ol5tfoi2d4gh9.apps.googleusercontent.com';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // åˆå§‹åŒ– Google API å®¢æˆ¶ç«¯
        function gapiLoaded() {
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                    });
                    gapiInited = true;
                    console.log('GAPI åˆå§‹åŒ–å®Œæˆ');
                    maybeEnableButtons();
                } catch (err) {
                    console.error('GAPI åˆå§‹åŒ–å¤±æ•—:', err);
                }
            });
        }

        // åˆå§‹åŒ– Google Identity Services
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: '', // å°‡åœ¨éœ€è¦æ™‚è¨­å®š
                error_callback: (err) => {
                    console.error('GIS éŒ¯èª¤:', err);
                }
            });
            gisInited = true;
            console.log('GIS åˆå§‹åŒ–å®Œæˆ');
            maybeEnableButtons();
        }

        // æª¢æŸ¥ä¸¦å•Ÿç”¨æŒ‰éˆ•
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                exportBtn.disabled = false;
            }
        }

        // åˆå§‹åŒ– Google Sheets API
        async function initGoogleSheetsAPI() {
            try {
                console.log('é–‹å§‹åˆå§‹åŒ– Google Sheets API...');
                if (!gapiInited || !gisInited) {
                    throw new Error('è«‹ç­‰å¾… Google API åˆå§‹åŒ–å®Œæˆ');
                }
                // æª¢æŸ¥æ˜¯å¦æœ‰å­˜å„²çš„è¨ªå•ä»¤ç‰Œ
                const token = localStorage.getItem('gapi_access_token');
                const tokenExpiry = localStorage.getItem('gapi_token_expiry');
                if (token && tokenExpiry && new Date(tokenExpiry) > new Date()) {
                    gapi.client.setToken({ access_token: token });
                    return true;
                }
                return new Promise((resolve, reject) => {
                    try {
                        tokenClient.callback = async (resp) => {
                            if (resp.error !== undefined) {
                                reject(resp);
                                return;
                            }
                            // å„²å­˜è¨ªå•ä»¤ç‰Œå’ŒéæœŸæ™‚é–“
                            if (resp.access_token) {
                                gapi.client.setToken({ access_token: resp.access_token });
                                localStorage.setItem('gapi_access_token', resp.access_token);
                                const expiry = new Date();
                                expiry.setHours(expiry.getHours() + 1);
                                localStorage.setItem('gapi_token_expiry', expiry.toISOString());
                            }
                            console.log('å·²æˆåŠŸå–å¾—å­˜å–æ¬Šæ–');
                            resolve(true);
                        };
                        if (gapi.client.getToken() === null) {
                            tokenClient.requestAccessToken({
                                prompt: 'consent',
                                hint: localStorage.getItem('user_email')
                            });
                        } else {
                            tokenClient.requestAccessToken({ prompt: '' });
                        }
                    } catch (err) {
                        console.error('æˆæ¬Šéç¨‹ç™¼ç”ŸéŒ¯èª¤:', err);
                        localStorage.removeItem('gapi_access_token');
                        localStorage.removeItem('gapi_token_expiry');
                        reject(err);
                    }
                });
            } catch (error) {
                console.error('Google Sheets API åˆå§‹åŒ–éŒ¯èª¤:', error);
                throw new Error(error.message || 'åˆå§‹åŒ–éç¨‹ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        // ç™»å‡º Google å¸³è™Ÿ
        async function signOut() {
            try {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken('');
                    localStorage.removeItem('gapi_access_token');
                    localStorage.removeItem('gapi_token_expiry');
                }
            } catch (error) {
                console.error('ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // åœ¨è¦–çª—é—œé–‰å‰å˜—è©¦ä¿å­˜æˆæ¬Šç‹€æ…‹
        window.addEventListener('beforeunload', () => {
            const token = gapi.client.getToken();
            if (token) {
                localStorage.setItem('gapi_access_token', token.access_token);
                const expiry = new Date();
                expiry.setHours(expiry.getHours() + 1);
                localStorage.setItem('gapi_token_expiry', expiry.toISOString());
            }
        });

        // å°‡è³‡æ–™å¯«å…¥ Google Sheets
        async function writeToGoogleSheets(records) {
            try {
                console.log('Current token:', gapi.client.getToken());
                console.log('é–‹å§‹å¯«å…¥è³‡æ–™åˆ°è©¦ç®—è¡¨...');
                // å…ˆå–å¾—ç¾æœ‰è³‡æ–™çš„æœ€å¾Œä¸€è¡Œ
                console.log('æª¢æŸ¥ç¾æœ‰è³‡æ–™...');
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${SHEET_NAME}!A:E`
                });

                let startRow = 1;
                if (response.result.values && response.result.values.length > 0) {
                    startRow = response.result.values.length + 1;
                }

                // æº–å‚™æ–°è³‡æ–™
                const values = records.map(record => [
                    formatDateTime(new Date(record.startTime)),
                    formatDateTime(new Date(record.endTime)),
                    record.content,
                    formatDurationHours(record.duration),
                    // åˆ†æ®µæ˜ç´°åˆä½µç‚ºå­—ä¸²
                    (record.segments && record.segments.length > 0)
                        ? record.segments.map(seg => {
                            const segStart = seg.start ? formatDateTime(new Date(seg.start)) : '';
                            const segEnd = seg.end ? formatDateTime(new Date(seg.end)) : '';
                            return `${segStart}ï½${segEnd}`;
                          }).join(' | ')
                        : (record.notes || '')
                ]);

                // å¦‚æœæ˜¯ç©ºç™½è©¦ç®—è¡¨ï¼Œå…ˆåŠ å…¥æ¨™é¡Œåˆ—
                if (startRow === 1) {
                    values.unshift(['é–‹å§‹æ™‚é–“', 'çµæŸæ™‚é–“', 'å·¥ä½œå…§å®¹', 'æ™‚æ•¸(hr)', 'å‚™è¨»/åˆ†æ®µæ˜ç´°']);
                }

                // å¯«å…¥æ–°è³‡æ–™
                console.log('å¯«å…¥æ–°è³‡æ–™...');
                const updateResponse = await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${SHEET_NAME}!A${startRow}:E${startRow + values.length - 1}`,
                    valueInputOption: 'USER_ENTERED',
                    resource: { values }
                });

                console.log('è³‡æ–™å¯«å…¥å®Œæˆ:', updateResponse);
                return true;
            } catch (error) {
                console.error('å¯«å…¥è©¦ç®—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error, error.result);
                alert('è©³ç´°éŒ¯èª¤ï¼š' + (error.result?.error?.message || error.message || 'æœªçŸ¥éŒ¯èª¤'));
                throw new Error(error.message || 'å¯«å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
            }
        }

        // ä¿®æ”¹åŒ¯å‡ºåŠŸèƒ½
        async function exportData() {
            if (workRecords.length === 0) {
                alert('æ²’æœ‰ç´€éŒ„å¯ä»¥åŒ¯å‡ºã€‚');
                return;
            }

            const originalButtonText = exportBtn.innerHTML;
            exportBtn.disabled = true;
            exportBtn.innerHTML = `
                <div class="spinner !w-5 !h-5 !border-2 !mr-2"></div>
                åŒ¯å‡ºä¸­...`;

            try {
                await initGoogleSheetsAPI();
                await writeToGoogleSheets(workRecords);

                // å»ºç«‹ä¸€å€‹ç°¡å–®çš„æ©«å‘é€šçŸ¥
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-4 right-4 bg-white px-4 py-2 rounded-lg shadow-lg border border-green-200 animate-fade-in z-50 flex items-center space-x-3';
                notification.innerHTML = `
                    <span class="text-green-600 font-medium">åŒ¯å‡ºæˆåŠŸ</span>
                    <a href="https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}" 
                       target="_blank"
                       class="text-blue-600 hover:text-blue-500 font-medium flex items-center">
                        <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        é–‹å•Ÿè©¦ç®—è¡¨
                    </a>
                `;

                // æ·»åŠ æ·¡å…¥å‹•ç•«æ¨£å¼
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fade-in {
                        from { opacity: 0; transform: translateY(1rem); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    .animate-fade-in {
                        animation: fade-in 0.3s ease-out forwards;
                    }
                `;
                document.head.appendChild(style);

                // æ·»åŠ é€šçŸ¥åˆ°é é¢
                document.body.appendChild(notification);

                // 3ç§’å¾Œè‡ªå‹•ç§»é™¤é€šçŸ¥
                setTimeout(() => {
                    notification.style.animation = 'fade-in 0.3s ease-out reverse forwards';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);

                // æ›´æ–°åŒ¯å‡ºæŒ‰éˆ•ç‹€æ…‹
                exportBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    åŒ¯å‡ºæˆåŠŸï¼`;

            } catch (error) {
                console.error('åŒ¯å‡ºéŒ¯èª¤:', error);
                if (error.status === 401 || error.status === 403) {
                    localStorage.removeItem('gapi_access_token');
                    localStorage.removeItem('gapi_token_expiry');
                }
                alert(`åŒ¯å‡ºå¤±æ•—ï¼\n${error.message}`);
                exportBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    åŒ¯å‡ºå¤±æ•—`;
            } finally {
                setTimeout(() => {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalButtonText;
                }, 3000);
            }
        }

        // --- Helper Functions ---
        /**
         * Formats milliseconds into HH:MM:SS string
         * @param {number} ms - Milliseconds
         * @returns {string} Formatted time string
         */
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        /**
         * Formats Date object into a readable string including seconds (e.g., YYYY/MM/DD HH:MM:SS)
         * @param {Date} date - Date object
         * @returns {string} Formatted date string
         */
        function formatDateTime(date) {
            if (!date || isNaN(date)) return ''; // Check for invalid date
            try {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0'); // Add seconds
                return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`; // Include seconds in format
            } catch (e) {
                console.error("Error formatting date:", date, e);
                return ''; // Return empty string on error
            }
        }


        /**
         * Calculates duration in hours (float with 2 decimal places)
         * @param {number} ms - Duration in milliseconds
         * @returns {string} Duration in hours
         */
        function formatDurationHours(ms) {
            if (ms === null || ms === undefined || ms <= 0) return '0.00';
            const hours = ms / (1000 * 60 * 60);
            return hours.toFixed(2);
        }

        /**
         * Updates the timer display
         */
        function updateTimerDisplay() {
            if (!isRunning && pausedTime === 0 && !startTime) {
                 timerDisplay.textContent = '00:00:00';
                 return;
            }

            const now = Date.now();
            let elapsed;
            if (isRunning) {
                elapsed = now - startTime - pausedTime;
            } else { // Paused
                elapsed = pauseStart ? pauseStart - startTime - pausedTime : (startTime ? 0 - startTime - pausedTime : 0);
            }
            timerDisplay.textContent = formatTime(Math.max(0, elapsed)); // Ensure non-negative
        }

        // --- Timer Logic ---
        function startTimer() {
            if (isRunning) return;
            const now = Date.now();
            if (startTime === null) {
                startTime = now;
                pausedTime = 0;
                currentSegments = [{ start: new Date(now) }]; // æ–°å¢ï¼šé–‹å§‹ç¬¬ä¸€æ®µ
            } else {
                pausedTime += (pauseStart ? now - pauseStart : 0);
                pauseStart = null;
                // æ–°å¢ï¼šç¹¼çºŒæ™‚é–‹å§‹æ–°ä¸€æ®µ
                currentSegments.push({ start: new Date(now) });
            }
            isRunning = true;
            startPauseBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                æš«åœ`;
            startPauseBtn.classList.replace('btn-primary', 'btn-secondary');
            endBtn.disabled = false;
            clearInterval(timerInterval);
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function pauseTimer() {
            if (!isRunning) return;
            clearInterval(timerInterval);
            timerInterval = null;
            pauseStart = Date.now();
            isRunning = false;
            // æ–°å¢ï¼šæš«åœæ™‚è£œä¸Šç•¶å‰æ®µçš„ end
            if (currentSegments.length > 0 && !currentSegments[currentSegments.length - 1].end) {
                currentSegments[currentSegments.length - 1].end = new Date(pauseStart);
            }
            startPauseBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                ç¹¼çºŒ`;
            startPauseBtn.classList.replace('btn-secondary', 'btn-primary');
            updateTimerDisplay();
        }

        function endTimer() {
            if (startTime === null) return;
            const endTime = Date.now();
            let finalElapsedTime;
            if (isRunning) {
                clearInterval(timerInterval);
                finalElapsedTime = endTime - startTime - pausedTime;
            } else {
                finalElapsedTime = pauseStart ? pauseStart - startTime - pausedTime : 0;
            }
            finalElapsedTime = Math.max(0, finalElapsedTime);
            const startDate = new Date(startTime);
            const endDate = new Date(endTime);
            isRunning = false;
            startTime = null;
            pausedTime = 0;
            pauseStart = null;
            timerInterval = null;
            timerDisplay.textContent = '00:00:00';
            startPauseBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                é–‹å§‹`;
            startPauseBtn.classList.replace('btn-secondary', 'btn-primary');
            endBtn.disabled = true;
            // æ–°å¢ï¼šçµæŸæ™‚è£œä¸Šæœ€å¾Œä¸€æ®µçš„ end
            if (currentSegments.length > 0 && !currentSegments[currentSegments.length - 1].end) {
                currentSegments[currentSegments.length - 1].end = new Date(endTime);
            }
            openRecordModal(null, startDate, endDate, finalElapsedTime, '', '', currentSegments);
            currentSegments = [];
        }

        // --- Record Management ---
        function saveRecords() {
            try {
                localStorage.setItem('workRecords', JSON.stringify(workRecords));
            } catch (e) {
                console.error("Error saving records to localStorage:", e);
                alert("ç„¡æ³•å„²å­˜ç´€éŒ„ï¼Œæ‚¨çš„ç€è¦½å™¨å„²å­˜ç©ºé–“å¯èƒ½å·²æ»¿æˆ–ä¸æ”¯æ´ã€‚");
            }
        }

        function renderRecords() {
            recordList.innerHTML = '';
            if (workRecords.length === 0) {
                recordList.innerHTML = '<p class="placeholder-text">é‚„æ²’æœ‰å·¥ä½œç´€éŒ„å–”ï¼é–‹å§‹è¨˜éŒ„å§ï½</p>';
                 clearAllRecordsBtn.disabled = true;
                return;
            }
            clearAllRecordsBtn.disabled = false;


            const sortedRecords = [...workRecords].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

            sortedRecords.forEach(record => {
                const card = document.createElement('div');
                card.className = 'record-card flex justify-between items-start';
                const recordStartTime = record.startTime ? new Date(record.startTime) : null;
                const recordEndTime = record.endTime ? new Date(record.endTime) : null;
                // åˆ†æ®µæ˜ç´°
                let segmentsHtml = '';
                if (record.segments && record.segments.length > 0) {
                    segmentsHtml = `<div class="text-xs text-gray-500 mt-1"><span class="font-medium">åˆ†æ®µæ˜ç´°ï¼š</span><ul class="list-disc ml-5">` +
                        record.segments.map(seg => {
                            const segStart = seg.start ? formatDateTime(new Date(seg.start)) : '';
                            const segEnd = seg.end ? formatDateTime(new Date(seg.end)) : '';
                            return `<li>${segStart} ï½ ${segEnd}</li>`;
                        }).join('') + '</ul></div>';
                }
                card.innerHTML = `
                    <div class="flex-grow mr-4 min-w-0"> <p class="font-semibold text-pink-700 break-words">${record.content || 'æœªå‘½åå·¥ä½œ'}</p>
                        <p class="text-sm text-gray-600">
                            <span class="font-medium">æ™‚é–“ï¼š</span>${formatDateTime(recordStartTime)} - ${formatDateTime(recordEndTime)}
                        </p>
                        <p class="text-sm text-gray-600">
                            <span class="font-medium">æ™‚æ•¸ï¼š</span>${formatDurationHours(record.duration)} å°æ™‚
                        </p>
                        ${record.notes ? `<p class="text-sm text-gray-500 mt-1 break-words"><span class="font-medium">å‚™è¨»ï¼š</span>${record.notes}</p>` : ''}
                        ${segmentsHtml}
                    </div>
                    <div class="flex-shrink-0 space-x-2">
                        <button class="icon-btn edit-record-btn" data-id="${record.id}" title="ç·¨è¼¯">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                              <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="icon-btn delete-record-btn" data-id="${record.id}" title="åˆªé™¤">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                recordList.appendChild(card);
            });

            document.querySelectorAll('.edit-record-btn').forEach(btn => {
                btn.addEventListener('click', handleEditRecord);
            });
            document.querySelectorAll('.delete-record-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteRecord);
            });
        }

        function addRecord(recordData) {
            if (!recordData.startTime || !recordData.endTime || typeof recordData.duration !== 'number' || isNaN(recordData.startTime) || isNaN(recordData.endTime)) {
                console.error("Invalid record data:", recordData);
                alert("å„²å­˜ç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼šè³‡æ–™æ ¼å¼ä¸æ­£ç¢ºã€‚");
                return;
            }
            const newRecord = {
                id: Date.now().toString(),
                startTime: recordData.startTime.toISOString(),
                endTime: recordData.endTime.toISOString(),
                duration: recordData.duration,
                content: recordData.content || '',
                notes: recordData.notes || '',
                segments: recordData.segments || [] // æ–°å¢ï¼šåˆ†æ®µè³‡æ–™
            };
            workRecords.push(newRecord);
            saveRecords();
            renderRecords();
        }

         function updateRecord(id, updatedData) {
            workRecords = workRecords.map(record => {
                if (record.id === id) {
                    return {
                        ...record,
                        content: updatedData.content || '',
                        notes: updatedData.notes || '',
                        segments: updatedData.segments || [] // æ–°å¢ï¼šåˆ†æ®µè³‡æ–™
                    };
                }
                return record;
            });
            saveRecords();
            renderRecords();
        }

        function deleteRecord(id) {
            workRecords = workRecords.filter(record => record.id !== id);
            saveRecords();
            renderRecords();
        }

         function clearAllRecords() {
            if (workRecords.length === 0) return;
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·¥ä½œç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                workRecords = [];
                saveRecords();
                renderRecords();
            }
        }

        function handleEditRecord(event) {
             const id = event.currentTarget.dataset.id;
             const recordToEdit = workRecords.find(record => record.id === id);
             if (recordToEdit) {
                 const startTime = recordToEdit.startTime ? new Date(recordToEdit.startTime) : null;
                 const endTime = recordToEdit.endTime ? new Date(recordToEdit.endTime) : null;
                 if (startTime && endTime && !isNaN(startTime) && !isNaN(endTime)) {
                    // Use the updated formatDateTime function when opening modal
                    openRecordModal(recordToEdit.id, startTime, endTime, recordToEdit.duration, recordToEdit.content, recordToEdit.notes, recordToEdit.segments);
                 } else {
                    console.error("Invalid date found in record:", recordToEdit);
                    alert("ç„¡æ³•ç·¨è¼¯æ­¤ç´€éŒ„ï¼šç´€éŒ„ä¸­çš„æ™‚é–“æ ¼å¼éŒ¯èª¤ã€‚");
                 }
             }
        }

        function handleDeleteRecord(event) {
             const id = event.currentTarget.dataset.id;
             if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
                 deleteRecord(id);
             }
        }


        // --- To-Do List Management ---
        function saveTodos() {
             try {
                localStorage.setItem('todos', JSON.stringify(todos));
            } catch (e) {
                console.error("Error saving todos to localStorage:", e);
                alert("ç„¡æ³•å„²å­˜å¾…è¾¦äº‹é …ï¼Œæ‚¨çš„ç€è¦½å™¨å„²å­˜ç©ºé–“å¯èƒ½å·²æ»¿æˆ–ä¸æ”¯æ´ã€‚");
            }
        }

        function renderTodos() {
            todoList.innerHTML = '';
             if (todos.length === 0) {
                todoList.innerHTML = '<p class="placeholder-text">é‚„æ²’æœ‰å¾…è¾¦äº‹é …å–”ï¼æ–°å¢ä¸€äº›å§ï½</p>';
                clearAllTodosBtn.disabled = true;
                return;
            }
            clearAllTodosBtn.disabled = false;


            todos.forEach(todo => {
                const item = document.createElement('div');
                item.className = `todo-item flex items-center justify-between p-2 rounded-lg hover:bg-pink-50 transition-colors duration-200 ${todo.completed ? 'completed bg-pink-50' : ''}`;
                item.dataset.id = todo.id;
                const sanitizedText = document.createElement('span');
                sanitizedText.textContent = todo.text;

                item.innerHTML = `
                    <div class="flex items-center flex-grow mr-2 min-w-0"> <input type="checkbox" class="mr-3 h-5 w-5 text-pink-500 border-pink-300 rounded focus:ring-pink-400 todo-checkbox flex-shrink-0" ${todo.completed ? 'checked' : ''}>
                        <span class="flex-grow break-words ${todo.completed ? 'text-gray-400 line-through' : ''}">${sanitizedText.innerHTML}</span>
                         <input type="text" class="edit-todo-input hidden flex-grow border-pink-300 rounded px-1 py-0.5 mr-2" value="${todo.text}">
                    </div>
                    <div class="space-x-1 flex-shrink-0">
                         <button class="icon-btn save-todo-btn hidden" title="å„²å­˜">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                               <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                             </svg>
                         </button>
                         <button class="icon-btn edit-todo-btn" title="ç·¨è¼¯">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                              <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="icon-btn delete-todo-btn" title="åˆªé™¤">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                               <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                             </svg>
                        </button>
                    </div>
                `;
                todoList.appendChild(item);
            });

             document.querySelectorAll('.todo-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleToggleTodo);
            });
             document.querySelectorAll('.edit-todo-btn').forEach(btn => {
                btn.addEventListener('click', handleEditTodo);
            });
             document.querySelectorAll('.save-todo-btn').forEach(btn => {
                btn.addEventListener('click', handleSaveTodo);
            });
            document.querySelectorAll('.delete-todo-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteTodo);
            });
             document.querySelectorAll('.edit-todo-input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleSaveTodo(e);
                    }
                });
                 input.addEventListener('blur', (e) => {
                    const item = e.target.closest('.todo-item');
                    if (item) {
                        const saveBtn = item.querySelector('.save-todo-btn');
                        if (saveBtn && !saveBtn.classList.contains('hidden')) {
                            handleSaveTodo(e);
                        }
                    }
                 });
            });
        }

        function addTodo() {
            const text = newTodoInput.value.trim();
            if (text === '') return;

            const newTodo = {
                id: Date.now().toString(),
                text: text,
                completed: false
            };
            todos.push(newTodo);
            saveTodos();
            renderTodos();
            newTodoInput.value = '';
        }

        function toggleTodo(id) {
            todos = todos.map(todo =>
                todo.id === id ? { ...todo, completed: !todo.completed } : todo
            );
            saveTodos();
            renderTodos();
        }

        function editTodo(id, newText) {
             const text = newText.trim();
             if (text === '') {
                 alert("å¾…è¾¦äº‹é …å…§å®¹ä¸èƒ½ç‚ºç©ºï¼");
                 renderTodos();
                 return;
             };
             todos = todos.map(todo =>
                todo.id === id ? { ...todo, text: text } : todo
             );
             saveTodos();
             renderTodos();
        }

        function deleteTodo(id) {
            todos = todos.filter(todo => todo.id !== id);
            saveTodos();
            renderTodos();
        }

         function clearAllTodos() {
            if (todos.length === 0) return;
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å¾…è¾¦äº‹é …å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                todos = [];
                saveTodos();
                renderTodos();
            }
        }


        function handleToggleTodo(event) {
            const id = event.target.closest('.todo-item').dataset.id;
            toggleTodo(id);
        }

         function handleEditTodo(event) {
            const item = event.target.closest('.todo-item');
            if (!item.querySelector('.save-todo-btn').classList.contains('hidden')) {
                return;
            }

            document.querySelectorAll('.todo-item').forEach(otherItem => {
                const otherSaveBtn = otherItem.querySelector('.save-todo-btn');
                if (otherSaveBtn && !otherSaveBtn.classList.contains('hidden')) {
                    otherItem.querySelector('span').classList.remove('hidden');
                    otherItem.querySelector('.edit-todo-input').classList.add('hidden');
                    otherItem.querySelector('.edit-todo-btn').classList.remove('hidden');
                    otherSaveBtn.classList.add('hidden');
                    otherItem.querySelector('.delete-todo-btn').classList.remove('hidden');
                }
            });


            const span = item.querySelector('span');
            const input = item.querySelector('.edit-todo-input');
            const editBtn = item.querySelector('.edit-todo-btn');
            const saveBtn = item.querySelector('.save-todo-btn');
            const deleteBtn = item.querySelector('.delete-todo-btn');

            span.classList.add('hidden');
            input.classList.remove('hidden');
            input.value = span.textContent;
            input.focus();
            input.select();

            editBtn.classList.add('hidden');
            saveBtn.classList.remove('hidden');
            deleteBtn.classList.add('hidden');
         }

         function handleSaveTodo(event) {
             const item = event.target.closest('.todo-item');
             const id = item.dataset.id;
             const input = item.querySelector('.edit-todo-input');
             editTodo(id, input.value);
         }


        function handleDeleteTodo(event) {
             const id = event.target.closest('.todo-item').dataset.id;
             if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹å¾…è¾¦äº‹é …å—ï¼Ÿ')) {
                deleteTodo(id);
             }
        }

        // --- Modal Logic ---
        function openRecordModal(id = null, start, end, durationMs, content = '', notes = '', segments = []) {
             if (!start || !end || isNaN(start) || isNaN(end) || typeof durationMs !== 'number') {
                console.error("Invalid data passed to openRecordModal:", { id, start, end, durationMs, content, notes });
                alert("é–‹å•Ÿç´€éŒ„è¦–çª—æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼šæ™‚é–“è³‡æ–™ä¸æ­£ç¢ºã€‚");
                return;
            }

            recordIdInput.value = id || '';
            
            // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“ç‚º HTML datetime-local è¼¸å…¥æ ¼å¼
            const formatDateTimeLocal = (date) => {
                return new Date(date.getTime() - date.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, 16);
            };
            
            startTimeInput.value = formatDateTimeLocal(start);
            endTimeInput.value = formatDateTimeLocal(end);
            durationInput.value = formatDurationHours(durationMs);
            workContentInput.value = content;
            notesInput.value = notes;

            recordModal.dataset.startTime = start.toISOString();
            recordModal.dataset.endTime = end.toISOString();
            recordModal.dataset.duration = durationMs.toString();
            recordModal.dataset.segments = JSON.stringify(segments || []); // æ–°å¢ï¼šåˆ†æ®µè³‡æ–™

            recordModal.style.display = 'block';
            workContentInput.focus();
        }

        function closeRecordModal() {
            recordModal.style.display = 'none';
            delete recordModal.dataset.startTime;
            delete recordModal.dataset.endTime;
            delete recordModal.dataset.duration;
            delete recordModal.dataset.segments;
            recordIdInput.value = '';
            startTimeInput.value = '';
            endTimeInput.value = '';
            durationInput.value = '';
            workContentInput.value = '';
            notesInput.value = '';
            modalLoading.style.display = 'none';
            modalLoading.innerHTML = '<div class="spinner"></div> å„²å­˜ä¸­...';
        }

        function handleSaveRecord() {
            modalLoading.style.display = 'flex';
            const id = recordIdInput.value;
            const content = workContentInput.value.trim();
            const notes = notesInput.value.trim();
            const startTime = new Date(startTimeInput.value);
            const endTime = new Date(endTimeInput.value);
            const duration = parseInt(recordModal.dataset.duration, 10);
            const segments = (() => {
                try {
                    return JSON.parse(recordModal.dataset.segments || '[]');
                } catch (e) {
                    return [];
                }
            })();
            if (!content) {
                alert("è«‹è¼¸å…¥å·¥ä½œå…§å®¹ï¼");
                modalLoading.style.display = 'none';
                workContentInput.focus();
                return;
            }
            if (isNaN(startTime) || isNaN(endTime)) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é–‹å§‹å’ŒçµæŸæ™‚é–“ï¼");
                modalLoading.style.display = 'none';
                return;
            }
            if (endTime < startTime) {
                alert("çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼");
                modalLoading.style.display = 'none';
                return;
            }
            new Promise(resolve => setTimeout(resolve, 300))
                .then(() => {
                    if (id) {
                        updateRecord(id, {
                            content,
                            notes,
                            startTime,
                            endTime,
                            duration: endTime - startTime,
                            segments
                        });
                    } else {
                        const recordData = {
                            startTime,
                            endTime,
                            duration: endTime - startTime,
                            content,
                            notes,
                            segments
                        };
                        addRecord(recordData);
                    }
                    closeRecordModal();
                })
                .catch(error => {
                    console.error("Error during save process:", error);
                    modalLoading.style.display = 'none';
                });
        }

        // --- Event Listeners ---
        startPauseBtn.addEventListener('click', () => {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        });

        endBtn.addEventListener('click', endTimer);

        addTodoBtn.addEventListener('click', addTodo);
        newTodoInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        closeModalBtn.addEventListener('click', closeRecordModal);
        saveRecordBtn.addEventListener('click', handleSaveRecord);
        workContentInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                 e.preventDefault();
                 handleSaveRecord();
            }
        });
         notesInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                 e.preventDefault();
                 handleSaveRecord();
            }
        });

        exportBtn.addEventListener('click', exportData);

        clearAllRecordsBtn.addEventListener('click', clearAllRecords);
        clearAllTodosBtn.addEventListener('click', clearAllTodos);

        // æ–°å¢æŒ‰éˆ•äº‹ä»¶ç›£è½
        document.getElementById('addNewRecordBtn').addEventListener('click', () => {
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            openRecordModal(null, oneHourAgo, now, 3600000);
        });

        // ä¿®æ”¹é–‹å§‹å’ŒçµæŸæ™‚é–“çš„äº‹ä»¶ç›£è½ï¼Œç”¨æ–¼è‡ªå‹•è¨ˆç®—æ™‚æ•¸
        document.getElementById('startTime').addEventListener('change', updateDuration);
        document.getElementById('endTime').addEventListener('change', updateDuration);

        function updateDuration() {
            const startTime = new Date(document.getElementById('startTime').value);
            const endTime = new Date(document.getElementById('endTime').value);
            
            if (!isNaN(startTime) && !isNaN(endTime)) {
                const durationMs = endTime - startTime;
                if (durationMs >= 0) {
                    document.getElementById('duration').value = formatDurationHours(durationMs);
                    recordModal.dataset.duration = durationMs.toString();
                } else {
                    alert('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼');
                    document.getElementById('duration').value = '0.00';
                }
            }
        }

        window.addEventListener('click', (event) => {
          if (event.target == recordModal) {
            closeRecordModal();
          }
        });

        // --- Initial Load and Render ---
        function initializeApp() {
             try {
                const storedRecords = localStorage.getItem('workRecords');
                if (storedRecords) {
                    workRecords = JSON.parse(storedRecords);
                    workRecords = workRecords.filter(r => r && r.id && r.startTime && r.endTime && typeof r.duration === 'number');
                } else {
                    workRecords = [];
                }
            } catch (e) {
                console.error("Error parsing work records from localStorage:", e);
                workRecords = [];
                localStorage.removeItem('workRecords');
            }

            try {
                const storedTodos = localStorage.getItem('todos');
                if (storedTodos) {
                    todos = JSON.parse(storedTodos);
                    todos = todos.filter(t => t && t.id && typeof t.text === 'string' && typeof t.completed === 'boolean');
                } else {
                     todos = [];
                }
            } catch (e) {
                 console.error("Error parsing todos from localStorage:", e);
                 todos = [];
                 localStorage.removeItem('todos');
            }

            renderRecords();
            renderTodos();
            updateTimerDisplay();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // è¼‰å…¥ Google API
            gapiLoaded();
            gisLoaded();
            // ... å…¶ä»–åˆå§‹åŒ–ç¨‹å¼ç¢¼ ...
        });

    </script>

</body>
</html>
