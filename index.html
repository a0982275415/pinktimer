<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工時記錄器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #FFF0F5; /* 淡粉紅色背景 */
        }
        /* 主要容器樣式 */
        .main-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #FFFFFF; /* 白色背景 */
            border-radius: 1.5rem; /* 大圓角 */
            box-shadow: 0 10px 25px -5px rgba(219, 39, 119, 0.1), 0 8px 10px -6px rgba(219, 39, 119, 0.1); /* 粉色柔和陰影 */
            position: relative; /* 為了貓咪定位 */
            overflow: hidden; /* 避免貓咪超出範圍 */
        }
        /* 按鈕基本樣式 */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem; /* 圓角 */
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            display: inline-flex; /* Align icon and text */
            align-items: center;
            justify-content: center;
        }
        /* 按鈕禁用樣式 */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* 主要按鈕樣式 (粉色) */
        .btn-primary {
            background-color: #EC4899; /* 粉紅色 */
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #DB2777; /* 深一點的粉紅色 */
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(219, 39, 119, 0.2), 0 4px 6px -4px rgba(219, 39, 119, 0.2);
        }
        /* 次要按鈕樣式 (奶油色) */
        .btn-secondary {
            background-color: #FFFBEB; /* 奶油色 */
            color: #D97706; /* 搭配的文字顏色 */
            border: 1px solid #FDE68A;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #FEF3C7;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(245, 158, 11, 0.1), 0 4px 6px -4px rgba(245, 158, 11, 0.1);
        }
         /* 清除按鈕樣式 (淡紅色) */
        .btn-danger {
            background-color: #FEF2F2; /* Very light red */
            color: #DC2626; /* Red text */
            border: 1px solid #FECACA; /* Light red border */
            padding: 0.3rem 0.6rem; /* Smaller padding */
            font-size: 0.875rem; /* Smaller text */
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #FEE2E2; /* Slightly darker light red */
            color: #B91C1C; /* Darker red text */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.1), 0 2px 4px -2px rgba(220, 38, 38, 0.06);
        }
        /* 新增按鈕樣式 (淺藍色) */
        .btn-light-blue {
            background-color: #F0F9FF; /* Very light blue */
            color: #0369A1; /* Blue text */
            border: 1px solid #BAE6FD; /* Light blue border */
            padding: 0.3rem 0.6rem; /* Match danger button padding */
            font-size: 0.875rem; /* Match danger button font size */
        }
        .btn-light-blue:hover:not(:disabled) {
            background-color: #E0F2FE; /* Slightly darker light blue */
            color: #0284C7; /* Darker blue text */
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.1), 0 2px 4px -2px rgba(14, 165, 233, 0.06);
        }
        /* 圖示按鈕樣式 */
        .icon-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            color: #9CA3AF; /* 灰色 */
            transition: color 0.3s ease;
        }
        .icon-btn:hover {
            color: #EC4899; /* 粉紅色 */
        }
        /* 區塊標題樣式 */
        .section-title-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #F9A8D4; /* 淺粉紅底線 */
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #DB2777; /* 深粉紅色 */
            margin: 0; /* Remove default margin */
            padding: 0; /* Remove default padding */
            border: none; /* Remove individual border */
            display: inline-block;
        }
        /* 輸入框樣式 */
        input[type="text"], textarea {
            border: 1px solid #FBCFE8; /* 粉色邊框 */
            border-radius: 0.75rem; /* 圓角 */
            padding: 0.5rem 0.75rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #EC4899; /* 粉色 */
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2); /* 粉色外光暈 */
        }
        input[readonly], input.bg-gray-100[readonly] { /* Style readonly fields */
             background-color: #f3f4f6; /* Lighter gray */
             cursor: default;
             opacity: 0.7;
        }
        /* 待辦事項完成樣式 */
        .todo-item.completed span {
            text-decoration: line-through;
            color: #9CA3AF; /* 灰色 */
        }
        /* 貓咪 SVG 樣式 */
        .cat-illustration {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            width: 100px; /* 調整貓咪大小 */
            height: auto;
            opacity: 0.8; /* 稍微透明一點 */
            pointer-events: none; /* 避免擋住操作 */
        }
        /* 碼錶樣式 */
        #timerDisplay {
            font-size: 3.5rem; /* 放大碼錶字體 */
            font-weight: bold;
            color: #374151; /* 深灰色 */
            background-color: #FFFBEB; /* 奶油色背景 */
            padding: 1rem 2rem;
            border-radius: 1rem; /* 圓角 */
            display: inline-block; /* 使背景符合內容寬度 */
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* 內陰影增加立體感 */
            letter-spacing: 2px; /* 增加字間距 */
            min-width: 280px; /* 確保寬度 */
            text-align: center;
        }
        /* 紀錄卡片樣式 */
        .record-card {
            background-color: #FFFBEB; /* 奶油色 */
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #F9A8D4; /* 左側粉色邊框 */
        }
        /* Modal 樣式 */
        .modal {
            display: none; /* 預設隱藏 */
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); /* 半透明黑色背景 */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; /* 垂直置中 */
            padding: 25px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
        }
        /* 讀取中/儲存中提示 */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 60; /* 確保在 modal 之上 */
            font-weight: bold;
            color: #EC4899;
            border-radius: 1rem; /* Match modal content */
        }
        /* Spinner for loading state */
        .spinner {
          border: 4px solid rgba(0, 0, 0, 0.1);
          width: 36px;
          height: 36px;
          border-radius: 50%;
          border-left-color: #EC4899;
          margin-right: 10px;
          animation: spin 1s ease infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        /* Placeholder text style */
        .placeholder-text {
            color: #a1a1aa; /* Zinc 400 */
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }
    </style>
</head>
<body class="text-gray-700">

    <div class="main-container">

        <h1 class="text-3xl font-bold text-center mb-8 text-pink-600">工時記錄器</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

            <div class="space-y-6">
                <section class="text-center p-6 bg-white rounded-xl shadow-md border border-pink-100">
                    <h2 class="section-title mb-4">⏱️ 計時區</h2>
                    <div id="timerDisplay">00:00:00</div>
                    <div class="mt-6 space-x-4">
                        <button id="startPauseBtn" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                            開始
                        </button>
                        <button id="endBtn" class="btn btn-secondary" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 10a2 2 0 104 0 2 2 0 00-4 0z" clip-rule="evenodd" />
                            </svg>
                            結束
                        </button>
                    </div>
                </section>

                <section class="p-6 bg-white rounded-xl shadow-md border border-pink-100">
                    <div class="section-title-container">
                        <h2 class="section-title">📑 工作紀錄清單</h2>
                        <div class="space-x-2">
                            <button id="addNewRecordBtn" class="btn btn-light-blue" title="新增工作紀錄">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                                新增
                            </button>
                            <button id="clearAllRecordsBtn" class="btn btn-danger" title="清除所有工作紀錄">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                清除
                            </button>
                        </div>
                    </div>
                    <div id="recordList" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                        <p class="placeholder-text">還沒有工作紀錄喔！開始記錄吧～</p>
                    </div>
                     <button id="exportBtn" class="btn btn-primary mt-6 w-full" title="匯出所有紀錄為 CSV 檔案">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
                          <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
                        </svg>
                        匯出所有紀錄
                    </button>
                </section>
            </div>

            <div class="space-y-6">
                <section class="p-6 bg-white rounded-xl shadow-md border border-pink-100 h-full flex flex-col">
                     <div class="section-title-container">
                        <h2 class="section-title">📝 待辦清單</h2>
                         <button id="clearAllTodosBtn" class="btn btn-danger" title="清除所有待辦事項">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            清除
                        </button>
                    </div>
                    <div class="flex mb-4">
                        <input type="text" id="newTodoInput" placeholder="新增待辦事項..." class="flex-grow mr-2">
                        <button id="addTodoBtn" class="btn btn-primary px-3"> <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div id="todoList" class="space-y-2 overflow-y-auto flex-grow pr-2">
                         <p class="placeholder-text">還沒有待辦事項喔！新增一些吧～</p>
                    </div>
                </section>
            </div>
        </div>

        <svg class="cat-illustration" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
          <path fill="#FBCFE8" d="M48.1,-61.3C62.2,-53.1,73.4,-39.8,79.5,-24.8C85.6,-9.8,86.6,6.9,80.8,21.2C75,35.5,62.4,47.4,49.1,56.9C35.8,66.4,21.8,73.4,6.9,74.7C-8,76,-23.8,71.5,-38.8,64.1C-53.8,56.7,-67.9,46.4,-75.5,32.9C-83.1,19.4,-84.1,2.7,-79.9,-12.5C-75.7,-27.7,-66.3,-41.4,-54.1,-49.6C-41.9,-57.8,-26.9,-60.5,-13.4,-63.5C0,-66.5,14,-69.6,28.1,-70.5C42.2,-71.4,56.3,-70.1,60.4,-61.3" transform="translate(100 100) scale(0.9)"> </path>
           <circle cx="90" cy="90" r="5" fill="#374151"/>
          <circle cx="110" cy="90" r="5" fill="#374151"/>
          <path d="M 95 105 Q 100 115 105 105" stroke="#374151" stroke-width="2" fill="none"/>
        </svg>

    </div>

    <div id="recordModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="closeModalBtn">&times;</span>
        <h3 class="text-xl font-bold mb-4 text-pink-600">記錄工作</h3>
        <div class="space-y-3">
            <input type="hidden" id="recordId">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">開始時間</label>
                <input type="datetime-local" id="startTime" class="w-full rounded-lg border-pink-200 focus:border-pink-500 focus:ring focus:ring-pink-200">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">結束時間</label>
                <input type="datetime-local" id="endTime" class="w-full rounded-lg border-pink-200 focus:border-pink-500 focus:ring focus:ring-pink-200">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">工作時數 (小時)</label>
                <input type="text" id="duration" class="bg-gray-100" readonly>
            </div>
            <div>
                <label for="workContent" class="block text-sm font-medium text-gray-700 mb-1">工作內容</label>
                <input type="text" id="workContent" placeholder="請輸入工作內容...">
            </div>
            <div>
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                <textarea id="notes" rows="3" placeholder="選填"></textarea>
            </div>
            <div class="text-right pt-3">
                <button id="saveRecordBtn" class="btn btn-primary">儲存紀錄</button>
            </div>
        </div>
         <div id="modalLoading" class="loading-overlay" style="display: none;">
            <div class="spinner"></div> 儲存中...
        </div>
      </div>
    </div>


    <script>
        // --- DOM Elements ---
        const timerDisplay = document.getElementById('timerDisplay');
        const startPauseBtn = document.getElementById('startPauseBtn');
        const endBtn = document.getElementById('endBtn');
        const recordList = document.getElementById('recordList');
        const exportBtn = document.getElementById('exportBtn');
        const clearAllRecordsBtn = document.getElementById('clearAllRecordsBtn');
        const newTodoInput = document.getElementById('newTodoInput');
        const addTodoBtn = document.getElementById('addTodoBtn');
        const todoList = document.getElementById('todoList');
        const clearAllTodosBtn = document.getElementById('clearAllTodosBtn');


        // Modal elements
        const recordModal = document.getElementById('recordModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const saveRecordBtn = document.getElementById('saveRecordBtn');
        const recordIdInput = document.getElementById('recordId');
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');
        const durationInput = document.getElementById('duration');
        const workContentInput = document.getElementById('workContent');
        const notesInput = document.getElementById('notes');
        const modalLoading = document.getElementById('modalLoading');


        // --- Timer State ---
        let timerInterval = null;
        let startTime = null; // Date object when timer started
        let pausedTime = 0; // Total time paused in milliseconds
        let pauseStart = null; // Timestamp when pause started
        let isRunning = false;
        let currentSegments = []; // 新增：記錄每一段有效工時

        // --- Data Storage ---
        let workRecords = []; // Initialized in initializeApp
        let todos = [];       // Initialized in initializeApp

        // --- Google Sheets Integration ---
        const SPREADSHEET_ID = '1hGiFEh-WLTE05YReUgBghXRRlb8lO7z1HUJkDs5SFNU';
        const SHEET_NAME = '工時紀錄';
        const CLIENT_ID = '546512436191-n58cui9bj25js8m5p01ol5tfoi2d4gh9.apps.googleusercontent.com';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // 初始化 Google API 客戶端
        function gapiLoaded() {
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                    });
                    gapiInited = true;
                    console.log('GAPI 初始化完成');
                    maybeEnableButtons();
                } catch (err) {
                    console.error('GAPI 初始化失敗:', err);
                }
            });
        }

        // 初始化 Google Identity Services
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: '', // 將在需要時設定
                error_callback: (err) => {
                    console.error('GIS 錯誤:', err);
                }
            });
            gisInited = true;
            console.log('GIS 初始化完成');
            maybeEnableButtons();
        }

        // 檢查並啟用按鈕
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                exportBtn.disabled = false;
            }
        }

        // 初始化 Google Sheets API
        async function initGoogleSheetsAPI() {
            try {
                console.log('開始初始化 Google Sheets API...');
                if (!gapiInited || !gisInited) {
                    throw new Error('請等待 Google API 初始化完成');
                }
                // 檢查是否有存儲的訪問令牌
                const token = localStorage.getItem('gapi_access_token');
                const tokenExpiry = localStorage.getItem('gapi_token_expiry');
                if (token && tokenExpiry && new Date(tokenExpiry) > new Date()) {
                    gapi.client.setToken({ access_token: token });
                    return true;
                }
                return new Promise((resolve, reject) => {
                    try {
                        tokenClient.callback = async (resp) => {
                            if (resp.error !== undefined) {
                                reject(resp);
                                return;
                            }
                            // 儲存訪問令牌和過期時間
                            if (resp.access_token) {
                                gapi.client.setToken({ access_token: resp.access_token });
                                localStorage.setItem('gapi_access_token', resp.access_token);
                                const expiry = new Date();
                                expiry.setHours(expiry.getHours() + 1);
                                localStorage.setItem('gapi_token_expiry', expiry.toISOString());
                            }
                            console.log('已成功取得存取權杖');
                            resolve(true);
                        };
                        if (gapi.client.getToken() === null) {
                            tokenClient.requestAccessToken({
                                prompt: 'consent',
                                hint: localStorage.getItem('user_email')
                            });
                        } else {
                            tokenClient.requestAccessToken({ prompt: '' });
                        }
                    } catch (err) {
                        console.error('授權過程發生錯誤:', err);
                        localStorage.removeItem('gapi_access_token');
                        localStorage.removeItem('gapi_token_expiry');
                        reject(err);
                    }
                });
            } catch (error) {
                console.error('Google Sheets API 初始化錯誤:', error);
                throw new Error(error.message || '初始化過程發生錯誤');
            }
        }

        // 登出 Google 帳號
        async function signOut() {
            try {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken('');
                    localStorage.removeItem('gapi_access_token');
                    localStorage.removeItem('gapi_token_expiry');
                }
            } catch (error) {
                console.error('登出時發生錯誤:', error);
            }
        }

        // 在視窗關閉前嘗試保存授權狀態
        window.addEventListener('beforeunload', () => {
            const token = gapi.client.getToken();
            if (token) {
                localStorage.setItem('gapi_access_token', token.access_token);
                const expiry = new Date();
                expiry.setHours(expiry.getHours() + 1);
                localStorage.setItem('gapi_token_expiry', expiry.toISOString());
            }
        });

        // 將資料寫入 Google Sheets
        async function writeToGoogleSheets(records) {
            try {
                console.log('Current token:', gapi.client.getToken());
                console.log('開始寫入資料到試算表...');
                // 先取得現有資料的最後一行
                console.log('檢查現有資料...');
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${SHEET_NAME}!A:E`
                });

                let startRow = 1;
                if (response.result.values && response.result.values.length > 0) {
                    startRow = response.result.values.length + 1;
                }

                // 準備新資料
                const values = records.map(record => [
                    formatDateTime(new Date(record.startTime)),
                    formatDateTime(new Date(record.endTime)),
                    record.content,
                    formatDurationHours(record.duration),
                    // 分段明細合併為字串
                    (record.segments && record.segments.length > 0)
                        ? record.segments.map(seg => {
                            const segStart = seg.start ? formatDateTime(new Date(seg.start)) : '';
                            const segEnd = seg.end ? formatDateTime(new Date(seg.end)) : '';
                            return `${segStart}～${segEnd}`;
                          }).join(' | ')
                        : (record.notes || '')
                ]);

                // 如果是空白試算表，先加入標題列
                if (startRow === 1) {
                    values.unshift(['開始時間', '結束時間', '工作內容', '時數(hr)', '備註/分段明細']);
                }

                // 寫入新資料
                console.log('寫入新資料...');
                const updateResponse = await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${SHEET_NAME}!A${startRow}:E${startRow + values.length - 1}`,
                    valueInputOption: 'USER_ENTERED',
                    resource: { values }
                });

                console.log('資料寫入完成:', updateResponse);
                return true;
            } catch (error) {
                console.error('寫入試算表時發生錯誤:', error, error.result);
                alert('詳細錯誤：' + (error.result?.error?.message || error.message || '未知錯誤'));
                throw new Error(error.message || '寫入資料時發生錯誤');
            }
        }

        // 修改匯出功能
        async function exportData() {
            if (workRecords.length === 0) {
                alert('沒有紀錄可以匯出。');
                return;
            }

            const originalButtonText = exportBtn.innerHTML;
            exportBtn.disabled = true;
            exportBtn.innerHTML = `
                <div class="spinner !w-5 !h-5 !border-2 !mr-2"></div>
                匯出中...`;

            try {
                await initGoogleSheetsAPI();
                await writeToGoogleSheets(workRecords);

                // 建立一個簡單的橫向通知
                const notification = document.createElement('div');
                notification.className = 'fixed bottom-4 right-4 bg-white px-4 py-2 rounded-lg shadow-lg border border-green-200 animate-fade-in z-50 flex items-center space-x-3';
                notification.innerHTML = `
                    <span class="text-green-600 font-medium">匯出成功</span>
                    <a href="https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}" 
                       target="_blank"
                       class="text-blue-600 hover:text-blue-500 font-medium flex items-center">
                        <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                        </svg>
                        開啟試算表
                    </a>
                `;

                // 添加淡入動畫樣式
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fade-in {
                        from { opacity: 0; transform: translateY(1rem); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    .animate-fade-in {
                        animation: fade-in 0.3s ease-out forwards;
                    }
                `;
                document.head.appendChild(style);

                // 添加通知到頁面
                document.body.appendChild(notification);

                // 3秒後自動移除通知
                setTimeout(() => {
                    notification.style.animation = 'fade-in 0.3s ease-out reverse forwards';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);

                // 更新匯出按鈕狀態
                exportBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    匯出成功！`;

            } catch (error) {
                console.error('匯出錯誤:', error);
                if (error.status === 401 || error.status === 403) {
                    localStorage.removeItem('gapi_access_token');
                    localStorage.removeItem('gapi_token_expiry');
                }
                alert(`匯出失敗！\n${error.message}`);
                exportBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    匯出失敗`;
            } finally {
                setTimeout(() => {
                    exportBtn.disabled = false;
                    exportBtn.innerHTML = originalButtonText;
                }, 3000);
            }
        }

        // --- Helper Functions ---
        /**
         * Formats milliseconds into HH:MM:SS string
         * @param {number} ms - Milliseconds
         * @returns {string} Formatted time string
         */
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        /**
         * Formats Date object into a readable string including seconds (e.g., YYYY/MM/DD HH:MM:SS)
         * @param {Date} date - Date object
         * @returns {string} Formatted date string
         */
        function formatDateTime(date) {
            if (!date || isNaN(date)) return ''; // Check for invalid date
            try {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0'); // Add seconds
                return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`; // Include seconds in format
            } catch (e) {
                console.error("Error formatting date:", date, e);
                return ''; // Return empty string on error
            }
        }


        /**
         * Calculates duration in hours (float with 2 decimal places)
         * @param {number} ms - Duration in milliseconds
         * @returns {string} Duration in hours
         */
        function formatDurationHours(ms) {
            if (ms === null || ms === undefined || ms <= 0) return '0.00';
            const hours = ms / (1000 * 60 * 60);
            return hours.toFixed(2);
        }

        /**
         * Updates the timer display
         */
        function updateTimerDisplay() {
            if (!isRunning && pausedTime === 0 && !startTime) {
                 timerDisplay.textContent = '00:00:00';
                 return;
            }

            const now = Date.now();
            let elapsed;
            if (isRunning) {
                elapsed = now - startTime - pausedTime;
            } else { // Paused
                elapsed = pauseStart ? pauseStart - startTime - pausedTime : (startTime ? 0 - startTime - pausedTime : 0);
            }
            timerDisplay.textContent = formatTime(Math.max(0, elapsed)); // Ensure non-negative
        }

        // --- Timer Logic ---
        function startTimer() {
            if (isRunning) return;
            const now = Date.now();
            if (startTime === null) {
                startTime = now;
                pausedTime = 0;
                currentSegments = [{ start: new Date(now) }]; // 新增：開始第一段
            } else {
                pausedTime += (pauseStart ? now - pauseStart : 0);
                pauseStart = null;
                // 新增：繼續時開始新一段
                currentSegments.push({ start: new Date(now) });
            }
            isRunning = true;
            startPauseBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                暫停`;
            startPauseBtn.classList.replace('btn-primary', 'btn-secondary');
            endBtn.disabled = false;
            clearInterval(timerInterval);
            updateTimerDisplay();
            timerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function pauseTimer() {
            if (!isRunning) return;
            clearInterval(timerInterval);
            timerInterval = null;
            pauseStart = Date.now();
            isRunning = false;
            // 新增：暫停時補上當前段的 end
            if (currentSegments.length > 0 && !currentSegments[currentSegments.length - 1].end) {
                currentSegments[currentSegments.length - 1].end = new Date(pauseStart);
            }
            startPauseBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                繼續`;
            startPauseBtn.classList.replace('btn-secondary', 'btn-primary');
            updateTimerDisplay();
        }

        function endTimer() {
            if (startTime === null) return;
            const endTime = Date.now();
            let finalElapsedTime;
            if (isRunning) {
                clearInterval(timerInterval);
                finalElapsedTime = endTime - startTime - pausedTime;
            } else {
                finalElapsedTime = pauseStart ? pauseStart - startTime - pausedTime : 0;
            }
            finalElapsedTime = Math.max(0, finalElapsedTime);
            const startDate = new Date(startTime);
            const endDate = new Date(endTime);
            isRunning = false;
            startTime = null;
            pausedTime = 0;
            pauseStart = null;
            timerInterval = null;
            timerDisplay.textContent = '00:00:00';
            startPauseBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                開始`;
            startPauseBtn.classList.replace('btn-secondary', 'btn-primary');
            endBtn.disabled = true;
            // 新增：結束時補上最後一段的 end
            if (currentSegments.length > 0 && !currentSegments[currentSegments.length - 1].end) {
                currentSegments[currentSegments.length - 1].end = new Date(endTime);
            }
            openRecordModal(null, startDate, endDate, finalElapsedTime, '', '', currentSegments);
            currentSegments = [];
        }

        // --- Record Management ---
        function saveRecords() {
            try {
                localStorage.setItem('workRecords', JSON.stringify(workRecords));
            } catch (e) {
                console.error("Error saving records to localStorage:", e);
                alert("無法儲存紀錄，您的瀏覽器儲存空間可能已滿或不支援。");
            }
        }

        function renderRecords() {
            recordList.innerHTML = '';
            if (workRecords.length === 0) {
                recordList.innerHTML = '<p class="placeholder-text">還沒有工作紀錄喔！開始記錄吧～</p>';
                 clearAllRecordsBtn.disabled = true;
                return;
            }
            clearAllRecordsBtn.disabled = false;


            const sortedRecords = [...workRecords].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));

            sortedRecords.forEach(record => {
                const card = document.createElement('div');
                card.className = 'record-card flex justify-between items-start';
                const recordStartTime = record.startTime ? new Date(record.startTime) : null;
                const recordEndTime = record.endTime ? new Date(record.endTime) : null;
                // 分段明細
                let segmentsHtml = '';
                if (record.segments && record.segments.length > 0) {
                    segmentsHtml = `<div class="text-xs text-gray-500 mt-1"><span class="font-medium">分段明細：</span><ul class="list-disc ml-5">` +
                        record.segments.map(seg => {
                            const segStart = seg.start ? formatDateTime(new Date(seg.start)) : '';
                            const segEnd = seg.end ? formatDateTime(new Date(seg.end)) : '';
                            return `<li>${segStart} ～ ${segEnd}</li>`;
                        }).join('') + '</ul></div>';
                }
                card.innerHTML = `
                    <div class="flex-grow mr-4 min-w-0"> <p class="font-semibold text-pink-700 break-words">${record.content || '未命名工作'}</p>
                        <p class="text-sm text-gray-600">
                            <span class="font-medium">時間：</span>${formatDateTime(recordStartTime)} - ${formatDateTime(recordEndTime)}
                        </p>
                        <p class="text-sm text-gray-600">
                            <span class="font-medium">時數：</span>${formatDurationHours(record.duration)} 小時
                        </p>
                        ${record.notes ? `<p class="text-sm text-gray-500 mt-1 break-words"><span class="font-medium">備註：</span>${record.notes}</p>` : ''}
                        ${segmentsHtml}
                    </div>
                    <div class="flex-shrink-0 space-x-2">
                        <button class="icon-btn edit-record-btn" data-id="${record.id}" title="編輯">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                              <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="icon-btn delete-record-btn" data-id="${record.id}" title="刪除">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                recordList.appendChild(card);
            });

            document.querySelectorAll('.edit-record-btn').forEach(btn => {
                btn.addEventListener('click', handleEditRecord);
            });
            document.querySelectorAll('.delete-record-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteRecord);
            });
        }

        function addRecord(recordData) {
            if (!recordData.startTime || !recordData.endTime || typeof recordData.duration !== 'number' || isNaN(recordData.startTime) || isNaN(recordData.endTime)) {
                console.error("Invalid record data:", recordData);
                alert("儲存紀錄時發生錯誤：資料格式不正確。");
                return;
            }
            const newRecord = {
                id: Date.now().toString(),
                startTime: recordData.startTime.toISOString(),
                endTime: recordData.endTime.toISOString(),
                duration: recordData.duration,
                content: recordData.content || '',
                notes: recordData.notes || '',
                segments: recordData.segments || [] // 新增：分段資料
            };
            workRecords.push(newRecord);
            saveRecords();
            renderRecords();
        }

         function updateRecord(id, updatedData) {
            workRecords = workRecords.map(record => {
                if (record.id === id) {
                    return {
                        ...record,
                        content: updatedData.content || '',
                        notes: updatedData.notes || '',
                        segments: updatedData.segments || [] // 新增：分段資料
                    };
                }
                return record;
            });
            saveRecords();
            renderRecords();
        }

        function deleteRecord(id) {
            workRecords = workRecords.filter(record => record.id !== id);
            saveRecords();
            renderRecords();
        }

         function clearAllRecords() {
            if (workRecords.length === 0) return;
            if (confirm('確定要清除所有工作紀錄嗎？此操作無法復原！')) {
                workRecords = [];
                saveRecords();
                renderRecords();
            }
        }

        function handleEditRecord(event) {
             const id = event.currentTarget.dataset.id;
             const recordToEdit = workRecords.find(record => record.id === id);
             if (recordToEdit) {
                 const startTime = recordToEdit.startTime ? new Date(recordToEdit.startTime) : null;
                 const endTime = recordToEdit.endTime ? new Date(recordToEdit.endTime) : null;
                 if (startTime && endTime && !isNaN(startTime) && !isNaN(endTime)) {
                    // Use the updated formatDateTime function when opening modal
                    openRecordModal(recordToEdit.id, startTime, endTime, recordToEdit.duration, recordToEdit.content, recordToEdit.notes, recordToEdit.segments);
                 } else {
                    console.error("Invalid date found in record:", recordToEdit);
                    alert("無法編輯此紀錄：紀錄中的時間格式錯誤。");
                 }
             }
        }

        function handleDeleteRecord(event) {
             const id = event.currentTarget.dataset.id;
             if (confirm('確定要刪除這筆紀錄嗎？')) {
                 deleteRecord(id);
             }
        }


        // --- To-Do List Management ---
        function saveTodos() {
             try {
                localStorage.setItem('todos', JSON.stringify(todos));
            } catch (e) {
                console.error("Error saving todos to localStorage:", e);
                alert("無法儲存待辦事項，您的瀏覽器儲存空間可能已滿或不支援。");
            }
        }

        function renderTodos() {
            todoList.innerHTML = '';
             if (todos.length === 0) {
                todoList.innerHTML = '<p class="placeholder-text">還沒有待辦事項喔！新增一些吧～</p>';
                clearAllTodosBtn.disabled = true;
                return;
            }
            clearAllTodosBtn.disabled = false;


            todos.forEach(todo => {
                const item = document.createElement('div');
                item.className = `todo-item flex items-center justify-between p-2 rounded-lg hover:bg-pink-50 transition-colors duration-200 ${todo.completed ? 'completed bg-pink-50' : ''}`;
                item.dataset.id = todo.id;
                const sanitizedText = document.createElement('span');
                sanitizedText.textContent = todo.text;

                item.innerHTML = `
                    <div class="flex items-center flex-grow mr-2 min-w-0"> <input type="checkbox" class="mr-3 h-5 w-5 text-pink-500 border-pink-300 rounded focus:ring-pink-400 todo-checkbox flex-shrink-0" ${todo.completed ? 'checked' : ''}>
                        <span class="flex-grow break-words ${todo.completed ? 'text-gray-400 line-through' : ''}">${sanitizedText.innerHTML}</span>
                         <input type="text" class="edit-todo-input hidden flex-grow border-pink-300 rounded px-1 py-0.5 mr-2" value="${todo.text}">
                    </div>
                    <div class="space-x-1 flex-shrink-0">
                         <button class="icon-btn save-todo-btn hidden" title="儲存">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                               <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                             </svg>
                         </button>
                         <button class="icon-btn edit-todo-btn" title="編輯">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                              <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button class="icon-btn delete-todo-btn" title="刪除">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                               <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                             </svg>
                        </button>
                    </div>
                `;
                todoList.appendChild(item);
            });

             document.querySelectorAll('.todo-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleToggleTodo);
            });
             document.querySelectorAll('.edit-todo-btn').forEach(btn => {
                btn.addEventListener('click', handleEditTodo);
            });
             document.querySelectorAll('.save-todo-btn').forEach(btn => {
                btn.addEventListener('click', handleSaveTodo);
            });
            document.querySelectorAll('.delete-todo-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteTodo);
            });
             document.querySelectorAll('.edit-todo-input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleSaveTodo(e);
                    }
                });
                 input.addEventListener('blur', (e) => {
                    const item = e.target.closest('.todo-item');
                    if (item) {
                        const saveBtn = item.querySelector('.save-todo-btn');
                        if (saveBtn && !saveBtn.classList.contains('hidden')) {
                            handleSaveTodo(e);
                        }
                    }
                 });
            });
        }

        function addTodo() {
            const text = newTodoInput.value.trim();
            if (text === '') return;

            const newTodo = {
                id: Date.now().toString(),
                text: text,
                completed: false
            };
            todos.push(newTodo);
            saveTodos();
            renderTodos();
            newTodoInput.value = '';
        }

        function toggleTodo(id) {
            todos = todos.map(todo =>
                todo.id === id ? { ...todo, completed: !todo.completed } : todo
            );
            saveTodos();
            renderTodos();
        }

        function editTodo(id, newText) {
             const text = newText.trim();
             if (text === '') {
                 alert("待辦事項內容不能為空！");
                 renderTodos();
                 return;
             };
             todos = todos.map(todo =>
                todo.id === id ? { ...todo, text: text } : todo
             );
             saveTodos();
             renderTodos();
        }

        function deleteTodo(id) {
            todos = todos.filter(todo => todo.id !== id);
            saveTodos();
            renderTodos();
        }

         function clearAllTodos() {
            if (todos.length === 0) return;
            if (confirm('確定要清除所有待辦事項嗎？此操作無法復原！')) {
                todos = [];
                saveTodos();
                renderTodos();
            }
        }


        function handleToggleTodo(event) {
            const id = event.target.closest('.todo-item').dataset.id;
            toggleTodo(id);
        }

         function handleEditTodo(event) {
            const item = event.target.closest('.todo-item');
            if (!item.querySelector('.save-todo-btn').classList.contains('hidden')) {
                return;
            }

            document.querySelectorAll('.todo-item').forEach(otherItem => {
                const otherSaveBtn = otherItem.querySelector('.save-todo-btn');
                if (otherSaveBtn && !otherSaveBtn.classList.contains('hidden')) {
                    otherItem.querySelector('span').classList.remove('hidden');
                    otherItem.querySelector('.edit-todo-input').classList.add('hidden');
                    otherItem.querySelector('.edit-todo-btn').classList.remove('hidden');
                    otherSaveBtn.classList.add('hidden');
                    otherItem.querySelector('.delete-todo-btn').classList.remove('hidden');
                }
            });


            const span = item.querySelector('span');
            const input = item.querySelector('.edit-todo-input');
            const editBtn = item.querySelector('.edit-todo-btn');
            const saveBtn = item.querySelector('.save-todo-btn');
            const deleteBtn = item.querySelector('.delete-todo-btn');

            span.classList.add('hidden');
            input.classList.remove('hidden');
            input.value = span.textContent;
            input.focus();
            input.select();

            editBtn.classList.add('hidden');
            saveBtn.classList.remove('hidden');
            deleteBtn.classList.add('hidden');
         }

         function handleSaveTodo(event) {
             const item = event.target.closest('.todo-item');
             const id = item.dataset.id;
             const input = item.querySelector('.edit-todo-input');
             editTodo(id, input.value);
         }


        function handleDeleteTodo(event) {
             const id = event.target.closest('.todo-item').dataset.id;
             if (confirm('確定要刪除這個待辦事項嗎？')) {
                deleteTodo(id);
             }
        }

        // --- Modal Logic ---
        function openRecordModal(id = null, start, end, durationMs, content = '', notes = '', segments = []) {
             if (!start || !end || isNaN(start) || isNaN(end) || typeof durationMs !== 'number') {
                console.error("Invalid data passed to openRecordModal:", { id, start, end, durationMs, content, notes });
                alert("開啟紀錄視窗時發生錯誤：時間資料不正確。");
                return;
            }

            recordIdInput.value = id || '';
            
            // 格式化日期時間為 HTML datetime-local 輸入格式
            const formatDateTimeLocal = (date) => {
                return new Date(date.getTime() - date.getTimezoneOffset() * 60000)
                    .toISOString()
                    .slice(0, 16);
            };
            
            startTimeInput.value = formatDateTimeLocal(start);
            endTimeInput.value = formatDateTimeLocal(end);
            durationInput.value = formatDurationHours(durationMs);
            workContentInput.value = content;
            notesInput.value = notes;

            recordModal.dataset.startTime = start.toISOString();
            recordModal.dataset.endTime = end.toISOString();
            recordModal.dataset.duration = durationMs.toString();
            recordModal.dataset.segments = JSON.stringify(segments || []); // 新增：分段資料

            recordModal.style.display = 'block';
            workContentInput.focus();
        }

        function closeRecordModal() {
            recordModal.style.display = 'none';
            delete recordModal.dataset.startTime;
            delete recordModal.dataset.endTime;
            delete recordModal.dataset.duration;
            delete recordModal.dataset.segments;
            recordIdInput.value = '';
            startTimeInput.value = '';
            endTimeInput.value = '';
            durationInput.value = '';
            workContentInput.value = '';
            notesInput.value = '';
            modalLoading.style.display = 'none';
            modalLoading.innerHTML = '<div class="spinner"></div> 儲存中...';
        }

        function handleSaveRecord() {
            modalLoading.style.display = 'flex';
            const id = recordIdInput.value;
            const content = workContentInput.value.trim();
            const notes = notesInput.value.trim();
            const startTime = new Date(startTimeInput.value);
            const endTime = new Date(endTimeInput.value);
            const duration = parseInt(recordModal.dataset.duration, 10);
            const segments = (() => {
                try {
                    return JSON.parse(recordModal.dataset.segments || '[]');
                } catch (e) {
                    return [];
                }
            })();
            if (!content) {
                alert("請輸入工作內容！");
                modalLoading.style.display = 'none';
                workContentInput.focus();
                return;
            }
            if (isNaN(startTime) || isNaN(endTime)) {
                alert("請輸入有效的開始和結束時間！");
                modalLoading.style.display = 'none';
                return;
            }
            if (endTime < startTime) {
                alert("結束時間必須晚於開始時間！");
                modalLoading.style.display = 'none';
                return;
            }
            new Promise(resolve => setTimeout(resolve, 300))
                .then(() => {
                    if (id) {
                        updateRecord(id, {
                            content,
                            notes,
                            startTime,
                            endTime,
                            duration: endTime - startTime,
                            segments
                        });
                    } else {
                        const recordData = {
                            startTime,
                            endTime,
                            duration: endTime - startTime,
                            content,
                            notes,
                            segments
                        };
                        addRecord(recordData);
                    }
                    closeRecordModal();
                })
                .catch(error => {
                    console.error("Error during save process:", error);
                    modalLoading.style.display = 'none';
                });
        }

        // --- Event Listeners ---
        startPauseBtn.addEventListener('click', () => {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        });

        endBtn.addEventListener('click', endTimer);

        addTodoBtn.addEventListener('click', addTodo);
        newTodoInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });

        closeModalBtn.addEventListener('click', closeRecordModal);
        saveRecordBtn.addEventListener('click', handleSaveRecord);
        workContentInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                 e.preventDefault();
                 handleSaveRecord();
            }
        });
         notesInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                 e.preventDefault();
                 handleSaveRecord();
            }
        });

        exportBtn.addEventListener('click', exportData);

        clearAllRecordsBtn.addEventListener('click', clearAllRecords);
        clearAllTodosBtn.addEventListener('click', clearAllTodos);

        // 新增按鈕事件監聽
        document.getElementById('addNewRecordBtn').addEventListener('click', () => {
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
            openRecordModal(null, oneHourAgo, now, 3600000);
        });

        // 修改開始和結束時間的事件監聽，用於自動計算時數
        document.getElementById('startTime').addEventListener('change', updateDuration);
        document.getElementById('endTime').addEventListener('change', updateDuration);

        function updateDuration() {
            const startTime = new Date(document.getElementById('startTime').value);
            const endTime = new Date(document.getElementById('endTime').value);
            
            if (!isNaN(startTime) && !isNaN(endTime)) {
                const durationMs = endTime - startTime;
                if (durationMs >= 0) {
                    document.getElementById('duration').value = formatDurationHours(durationMs);
                    recordModal.dataset.duration = durationMs.toString();
                } else {
                    alert('結束時間必須晚於開始時間！');
                    document.getElementById('duration').value = '0.00';
                }
            }
        }

        window.addEventListener('click', (event) => {
          if (event.target == recordModal) {
            closeRecordModal();
          }
        });

        // --- Initial Load and Render ---
        function initializeApp() {
             try {
                const storedRecords = localStorage.getItem('workRecords');
                if (storedRecords) {
                    workRecords = JSON.parse(storedRecords);
                    workRecords = workRecords.filter(r => r && r.id && r.startTime && r.endTime && typeof r.duration === 'number');
                } else {
                    workRecords = [];
                }
            } catch (e) {
                console.error("Error parsing work records from localStorage:", e);
                workRecords = [];
                localStorage.removeItem('workRecords');
            }

            try {
                const storedTodos = localStorage.getItem('todos');
                if (storedTodos) {
                    todos = JSON.parse(storedTodos);
                    todos = todos.filter(t => t && t.id && typeof t.text === 'string' && typeof t.completed === 'boolean');
                } else {
                     todos = [];
                }
            } catch (e) {
                 console.error("Error parsing todos from localStorage:", e);
                 todos = [];
                 localStorage.removeItem('todos');
            }

            renderRecords();
            renderTodos();
            updateTimerDisplay();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 載入 Google API
            gapiLoaded();
            gisLoaded();
            // ... 其他初始化程式碼 ...
        });

    </script>

</body>
</html>
